graph TD
    subgraph 初始化阶段
        A[用户发送问题] --> B[初始化ChatFlow]
        B --> C1{是否有chat_id?}
        C1 -->|是| D1[加载现有聊天]
        C1 -->|否| D2[创建新聊天]
        D1 --> E[初始化LLM和知识库]
        D2 --> E
    end

    subgraph 聊天处理流程
        E --> F[chat方法入口]
        F --> G{引擎类型?}
        G -->|内置引擎| H[_builtin_chat]
        G -->|外部引擎| I[_external_chat]
        
        H --> J1[创建聊天消息记录]
        J1 --> J2[知识图谱搜索]
        J2 --> J3[问题优化重写]
        J3 --> J4{需要澄清?}
        J4 -->|是| J5[返回澄清请求]
        J4 -->|否| J6[搜索相关内容]
    end
    
    subgraph 双路径检索
        J6 --> K1[知识库检索]
        J6 --> K2{数据库功能启用?}
        
        K2 -->|是| K3[获取数据库上下文]
        K3 --> K4[_is_potential_database_query判断]
        K4 --> K5[执行数据库查询]
        
        K1 --> L[整合检索结果]
        K5 --> L
    end
    
    subgraph 回答生成
        L --> M1[选择提示词模板]
        M1 --> M2{有数据库结果?}
        M2 -->|是| M3[使用混合内容模板]
        M2 -->|否| M4[使用标准模板]
        
        M3 --> N[LLM生成回答]
        M4 --> N
        
        N --> O[提取源文档]
        O --> P[流式返回回答]
    end
    
    subgraph 完成处理
        P --> Q1[执行后验证]
        Q1 --> Q2[更新消息状态]
        Q2 --> Q3[保存到数据库]
        Q3 --> Q4[发送完成事件]
    end
    
    subgraph 数据库上下文管理
        K3 --> R1[检查缓存上下文]
        R1 --> R2[获取用户权限]
        R2 --> R3[获取查询历史]
        R3 --> R4[获取统计信息]
        R4 --> R5[分析用户指定数据库]
        R5 --> R6[构建推荐数据库]
        R6 --> R7[保存上下文]
    end
    
    J5 --> Q4
    Q4 --> S[聊天完成]