# 数据库问答与聊天引擎集成计划

## 1. 数据模型准备

- [ ] **1.1 扩展数据库连接模型**
  - [ ] 添加`description_for_llm`字段到`DatabaseConnection`模型
  - [ ] 添加`table_descriptions`字段(JSON类型)用于存储表描述
  - [ ] 添加`column_descriptions`字段(JSON类型)用于存储列描述
  - [ ] 添加相关索引以优化性能

- [ ] **1.2 创建数据库迁移脚本**
  - [ ] 编写Alembic迁移文件添加新字段
  - [ ] 确保向后兼容性
  - [ ] 编写数据迁移逻辑(如需要)

- [ ] **1.3 扩展聊天引擎配置模型**
  - [ ] 在`ChatEngineConfig`中完善`DatabaseOption`类，添加数据库查询相关设置
  - [ ] 实现`LinkedDatabaseConfig`类，支持单引擎多数据库配置
  - [ ] 添加查询模式、权限设置等配置项

## 2. 数据库查询集成

- [ ] **2.1 实现SQLQueryTool工具类**
  - [ ] 使用LlamaIndex封装数据库连接和查询功能
  - [ ] 实现异常处理和日志记录
  - [ ] 支持动态选择表和构建上下文
  - [ ] 添加查询结果缓存

- [ ] **2.2 实现数据库路由系统**
  - [ ] 创建`DatabaseQueryRouter`类，支持多数据库智能路由
  - [ ] 使用LLM分析查询意图和目标数据库
  - [ ] 实现数据库描述和业务场景的上下文管理

- [ ] **2.3 集成到检索流程**
  - [ ] 在`RetrieveFlow`类中增加`retrieve_from_database`方法
  - [ ] 修改现有`retrieve`方法，整合数据库检索结果
  - [ ] 实现查询结果格式化为`SourceDocument`

## 3. 聊天引擎集成

- [ ] **3.1 扩展聊天引擎配置**
  - [ ] 更新`ChatEngineConfig`加载逻辑，支持数据库配置
  - [ ] 实现数据库连接权限检查
  - [ ] 添加业务场景描述配置项

- [ ] **3.2 修改聊天流程**
  - [ ] 根据用户问题分析是否需要数据库查询
  - [ ] 优化查询结果和知识库内容的混合策略
  - [ ] 添加查询失败的回退机制

- [ ] **3.3 调整Prompt模板**
  - [ ] 创建专用于数据库查询的提示词模板
  - [ ] 优化联合检索的提示词模板
  - [ ] 支持业务描述注入到提示词中

## 4. 存储库与API层

- [ ] **4.1 数据库连接仓库扩展**
  - [ ] 添加表格描述和列描述的CRUD方法
  - [ ] 实现权限检查逻辑
  - [ ] 支持数据库元信息缓存管理

- [ ] **4.2 API接口开发**
  - [ ] 实现表/列描述管理API
  - [ ] 扩展聊天引擎配置API支持数据库设置
  - [ ] 添加数据库连接测试API

- [ ] **4.3 自动描述生成功能**
  - [ ] 实现使用LLM生成表和列描述的功能
  - [ ] 设计描述优化逻辑
  - [ ] 提供批量生成和单项生成接口

## 5. 前端界面实现

- [ ] **5.1 数据库描述管理页面**
  - [ ] 表格和列描述编辑界面
  - [ ] 自动描述生成功能按钮
  - [ ] 描述预览功能

- [ ] **5.2 聊天引擎配置界面扩展**
  - [ ] 添加数据库查询设置选项卡
  - [ ] 实现业务描述和环境说明配置
  - [ ] 支持多数据库连接配置

- [ ] **5.3 聊天界面优化**
  - [ ] 显示SQL查询来源标记
  - [ ] 优化表格数据展示
  - [ ] 添加数据库查询调试信息(可选)

## 6. 测试与文档

- [ ] **6.1 单元测试**
  - [ ] 测试SQLQueryTool功能
  - [ ] 测试数据库路由逻辑
  - [ ] 测试存储和API功能

- [ ] **6.2 集成测试**
  - [ ] 测试整个聊天流程中的数据库查询
  - [ ] 测试多数据库环境
  - [ ] 测试错误处理和回退机制

- [ ] **6.3 文档编写**
  - [ ] 更新开发文档
  - [ ] 编写用户使用手册
  - [ ] 添加配置示例

## 实施策略

1. **先搭建基础架构**：完成数据模型、迁移脚本和基础工具类
2. **实现核心功能**：数据库查询集成和路由系统
3. **集成到聊天流程**：修改检索流程和聊天逻辑
4. **开发管理界面**：实现描述管理和配置界面
5. **完善细节**：优化用户体验和错误处理
6. **测试和文档**：确保功能可靠性并提供使用指南

这个计划整合了AutoFlow现有的架构和设计模式，遵循了项目的代码组织方式和命名规范。执行时可以根据实际情况调整任务顺序，优先完成核心功能，然后逐步完善其他部分。
