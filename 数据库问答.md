# 数据库问答与聊天引擎集成计划

本文档列出了将数据库问答功能集成到聊天引擎中的计划和进度追踪。

## 1. 数据模型准备

- [x] 1.1 扩展 DatabaseConnection 模型
  - [x] 1.1.1 添加 description_for_llm 字段（用于提供给 LLM 的业务场景描述）
  - [x] 1.1.2 添加 table_descriptions 字段（表的业务含义描述）
  - [x] 1.1.3 添加 column_descriptions 字段（列的业务含义描述）
  - [x] 1.1.4 添加 metadata_cache 字段（用于缓存数据库结构元数据）
  - [x] 1.1.5 添加 last_connected_at 和 status 字段（连接状态跟踪）

- [x] 1.2 创建迁移脚本
  - [x] 1.2.1 编写 Alembic 迁移脚本，添加新字段
  - [x] 1.2.2 确保迁移脚本可以安全回滚

- [x] 1.3 更新数据库连接 API
  - [x] 1.3.1 扩展连接测试 API，返回更多诊断信息
  - [x] 1.3.2 添加元数据刷新 API 端点

## 2. 数据库查询集成

- [x] 2.1 创建 SQL 查询工具类
  - [x] 2.1.1 实现 SQLQueryTool 类（基于 llama_index 的 SQLTableQueryEngine）
  - [x] 2.1.2 支持不同数据库类型的 SQL 生成优化
  - [x] 2.1.3 添加查询结果格式化逻辑

- [x] 2.2 实现数据库连接管理
  - [x] 2.2.1 添加数据库连接池管理
  - [x] 2.2.2 支持连接超时和自动重连
  - [x] 2.2.3 实现连接权限控制

- [x] 2.3 实现查询转换和执行
  - [x] 2.3.1 自然语言到 SQL 的转换（LLM 驱动）
  - [x] 2.3.2 SQL 执行和结果处理
  - [x] 2.3.3 错误处理和用户友好的错误消息

- [x] 2.4 集成到检索流程
  - [x] 2.4.1 在 RetrieveFlow 类中添加 retrieve_from_database 函数
  - [x] 2.4.2 修改 retrieve 方法以集成数据库检索结果
  - [x] 2.4.3 实现查询结果格式化为 SourceDocument
  - [x] 2.4.4 优化混合检索结果的排序和展示

## 3. 聊天引擎集成

- [x] 3.1 完善聊天引擎配置
  - [x] 3.1.1 增强数据库连接权限验证
    - [x] 在权限验证中添加用户角色支持
    - [x] 实现用户访问权限级别（READ_ONLY, READ_WRITE, ADMIN）
    - [x] 添加敏感操作保护机制和增强的权限检查模式
  - [x] 3.1.2 添加数据库路由策略配置
    - [x] 创建数据库路由策略枚举类型
    - [x] 添加多样化的路由策略与配置选项
    - [x] 支持LLM辅助的数据库选择功能
    - [x] 实现基于上下文的智能路由功能
  - [x] 3.1.3 支持按对话控制数据库访问权限
    - [x] 实现对话级别的数据库上下文提取
    - [x] 支持从用户消息中提取数据库指令
    - [x] 添加基于对话标签和历史的数据库路由优化
    - [x] 实现对话级别的数据库权限缓存和控制

### 3.1.1 实现数据库连接权限验证

- [x] 增强 DatabaseQueryManager 中的权限检查
  - [x] 添加基于用户角色的权限验证
  - [x] 实现不同级别的用户权限控制（只读、读写、管理员）
  - [x] 添加敏感查询保护机制
- [x] 支持用户角色和权限级别限制
  - [x] 创建 UserAccessLevel 枚举定义不同访问级别
  - [x] 增强 LinkedDatabaseConfig 配置，支持更细粒度的访问控制
  - [x] 实现默认和自定义的权限控制策略
- [x] 实现敏感查询操作的权限验证和审计
  - [x] 添加敏感查询识别逻辑
  - [x] 针对敏感操作实施更严格的权限控制
  - [x] 完善审计日志记录

### 3.1.2 实现数据库路由策略配置

- [x] 创建 DatabaseRoutingStrategy 枚举类
  - [x] 定义多种路由策略（SINGLE_BEST, ALL_QUALIFIED, TOP_N, MANUAL, CONTEXTUAL）
  - [x] 在数据库选项中添加策略选择与相关配置
  - [x] 实现不同策略的参数配置（如排序阈值、TOP_N值等）
- [x] 创建 DatabaseRouter 路由器类
  - [x] 实现基于关键词匹配的相似度计算
  - [x] 支持权重调整和标签匹配
  - [x] 添加主数据库优先级处理
  - [x] 实现回退策略处理
- [x] 支持LLM辅助的数据库智能选择
  - [x] 设计LLM路由评分提示词模板
  - [x] 实现LLM路由评分结果解析
  - [x] 添加LLM路由错误处理和回退机制
- [x] 更新 DatabaseQueryManager 以使用新的路由系统
  - [x] 集成 DatabaseRouter 到查询流程
  - [x] 支持按照路由分数排序和筛选数据库
  - [x] 优化结果处理以支持不同路由策略

### 3.1.3 支持按对话控制数据库访问权限

- [x] 实现对话级别的数据库上下文管理
  - [x] 添加对话级别的数据库上下文提取方法
  - [x] 支持在对话流程中维护数据库查询状态
  - [x] 将上下文信息传递给数据库查询管理器
- [x] 支持用户指令识别和处理
  - [x] 实现从用户消息中提取数据库相关指令
  - [x] 支持通过数据库名称或ID指定查询目标
  - [x] 解析用户的自然语言数据库选择指令
- [x] 增强对话级别的权限控制
  - [x] 获取并应用对话特定的数据库访问限制
  - [x] 支持基于对话业务场景的数据库筛选
  - [x] 记录和利用历史查询数据库信息

- [x] 3.2 更新提示词模板
  - [x] 3.2.1 更新对话生成提示词以支持 SQL 查询
  - [x] 3.2.2 添加数据库查询相关提示词
  - [x] 3.2.3 优化提示词以处理混合内容（知识库 + 数据库结果）

### 3.2.1 更新提示词模板实现

- [x] 更新TEXT_QA_PROMPT模板
  - [x] 添加数据库查询结果部分
  - [x] 增加数据库结果引用格式指南
  - [x] 加入数据库结果与知识文档综合处理的指导
- [x] 添加数据库查询专用提示词模板
  - [x] 创建DATABASE_AWARE_CONDENSE_QUESTION_PROMPT用于优化潜在数据库查询问题
  - [x] 实现查询潜力识别逻辑，检测可能涉及数据库的问题
  - [x] 优化问题重构，突出实体、属性、条件和时间范围
- [x] 创建混合内容处理模板
  - [x] 开发HYBRID_RESPONSE_SYNTHESIS_PROMPT专门处理数据库和知识库混合结果
  - [x] 定义信息优先级规则，适当权衡结构化数据与非结构化知识
  - [x] 设计不同数据类型的展示格式和综合策略

- [x] 3.3 完善对话状态管理
  - [x] 3.3.1 在对话状态中存储数据库查询历史
  - [x] 3.3.2 实现对话级别的数据库权限缓存
  - [x] 3.3.3 支持多轮数据库问答（上下文理解）

### 3.3.1 对话状态中的数据库查询历史管理

- [x] 创建数据库查询历史存储模型
  - [x] 设计 `DatabaseQueryHistory` 模型类，包含查询ID、聊天ID、用户ID、连接信息等字段
  - [x] 添加结果摘要字段，存储查询结果的结构化摘要
  - [x] 包含性能指标字段，如执行时间、返回行数等
  - [x] 添加用户反馈相关字段，如评分和反馈内容
- [x] 实现查询历史仓库层
  - [x] 创建 `DatabaseQueryHistoryRepo` 类，负责历史数据的CRUD操作
  - [x] 添加按聊天ID、用户ID、时间筛选等查询方法
  - [x] 实现查询统计功能，支持获取聊天会话中的查询统计信息
- [x] 增强 `DatabaseQueryManager` 添加查询历史记录功能
  - [x] 修改 `query_databases` 方法，在执行查询后自动记录历史
  - [x] 添加 `get_recent_queries` 方法，获取最近的查询记录
  - [x] 实现 `get_query_statistics` 方法，提供聊天查询统计数据

### 3.3.2 对话级别的数据库权限缓存

- [x] 增强对话状态维护
  - [x] 在 `_get_chat_db_restrictions` 方法中实现权限信息缓存
  - [x] 使用 `ChatMeta` 模型存储对话级别的数据库权限信息
  - [x] 添加缓存过期时间控制，避免过时的权限信息
- [x] 优化权限检查流程
  - [x] 实现基于缓存的快速权限验证
  - [x] 添加缓存刷新机制，在权限变更时更新缓存
  - [x] 确保实时与用户权限系统同步

### 3.3.3 多轮数据库问答上下文理解

- [x] 增强对话上下文管理
  - [x] 改进 `_get_database_context` 方法，维护更完整的对话数据库上下文
  - [x] 使用 `ChatMeta` 存储对话级别的数据库上下文信息
  - [x] 在上下文中包含历史查询、数据库统计和推荐数据库等信息
- [x] 增强多轮查询意图识别
  - [x] 更新 `_is_potential_database_query` 方法，支持多重策略判断
  - [x] 添加对话历史分析，识别跟进问题和上下文延续
  - [x] 使用缓存的数据库上下文辅助查询意图判断
- [x] 实现数据库上下文的智能利用
  - [x] 基于历史查询和对话上下文，提供智能数据库推荐
  - [x] 支持对话级别的数据库切换和维护
  - [x] 在查询路由中利用历史查询信息优化数据库选择

## 4. 存储层和 API 层

- [x] 4.1 数据库查询历史存储
  - [x] 4.1.1 创建 DatabaseQueryHistory 模型
  - [x] 4.1.2 实现查询历史的记录和检索

- [x] 4.2 API 端点扩展
  - [x] 4.2.1 添加获取可用数据库列表的 API
  - [x] 4.2.2 添加数据库查询历史 API
  - [x] 4.2.3 支持用户反馈（查询结果评分）

### 4.1.1 数据库查询历史模型实现

- [x] 设计 `DatabaseQueryHistory` 模型
  - [x] 实现与 `ChatMessage` 和 `DatabaseConnection` 的关联
  - [x] 添加查询执行细节（SQL语句、执行时间等）
  - [x] 包含查询结果摘要和样本数据
  - [x] 支持用户反馈和评分

### 4.1.2 查询历史存储和检索实现

- [x] 完善 `DatabaseQueryHistoryRepo` 仓库类
  - [x] 实现按聊天ID获取查询历史方法
  - [x] 实现按用户ID获取历史查询方法
  - [x] 添加查询统计功能
  - [x] 支持用户反馈更新
  - [x] 实现历史查询搜索功能

### 4.2.1 数据库列表API实现

- [x] 创建 `/database/connections` API端点
  - [x] 获取当前用户可用的数据库连接列表
  - [x] 根据用户权限过滤可访问的数据库
  - [x] 返回必要的数据库元信息
  - [x] 添加错误处理和日志记录

### 4.2.2 数据库查询历史API实现

- [x] 实现查询历史相关API端点
  - [x] 创建 `/chats/{chat_id}/database/queries` 端点获取聊天查询历史
  - [x] 实现 `/database/queries/recent` 端点获取用户最近查询历史
  - [x] 添加 `/chats/{chat_id}/database/statistics` 端点获取统计信息
  - [x] 支持分页和结果过滤
  - [x] 添加适当的访问权限控制

### 4.2.3 用户反馈API实现

- [x] 实现查询反馈API端点
  - [x] 创建 `/database/queries/{query_id}/feedback` 端点提交反馈
  - [x] 支持评分(1-5)和文字反馈
  - [x] 实现权限检查和验证
  - [x] 添加反馈数据的存储和检索

## 5. 前端实现

- [x] 5.1 聊天界面增强
  - [x] 5.1.1 添加数据库查询结果的表格展示
  - [x] 5.1.2 支持查询 SQL 的展示和复制
  - [x] 5.1.3 实现查询结果的导出功能

- [x] 5.2 数据库管理界面
  - [x] 5.2.1 创建数据库连接管理页面
  - [x] 5.2.2 实现表描述和列描述的编辑界面
  - [x] 5.2.3 添加数据库权限配置 UI

## 6. 测试和文档

- [ ] 6.1 单元测试
  - [ ] 6.1.1 数据库查询工具的单元测试
  - [ ] 6.1.2 权限控制逻辑的单元测试

- [ ] 6.2 集成测试
  - [ ] 6.2.1 端到端的数据库问答测试
  - [ ] 6.2.2 多种数据库类型的兼容性测试

- [ ] 6.3 文档
  - [ ] 6.3.1 用户指南（如何配置和使用数据库问答）
  - [ ] 6.3.2 开发者文档（系统架构和扩展指南）
  - [ ] 6.3.3 API 文档更新

## 实施策略

### AutoFlow数据库问答功能开发计划（基于LlamaIndex）

#### 目标
实现用户通过自然语言查询企业数据库的功能，提供准确、安全的数据库问答能力。

#### 技术选型
1. 使用LlamaIndex作为核心框架，利用其NL to SQL和数据库查询能力
2. 基于当前RAG聊天引擎架构进行扩展
3. 采用多阶段集成策略，确保稳定性和性能

#### 分阶段实施计划

**阶段一：基础集成与核心功能 (对应 `数据库问答.md` 1, 2.1-2.3)**

1. **1.1 扩展数据库连接模型**
    * **任务：**
        * 向 `DatabaseConnection` 模型添加以下字段（用于更好地支持LlamaIndex）：
            * `description_for_llm`: 用于提供给LLM的业务描述
            * `table_descriptions`: 表的业务含义描述
            * `column_descriptions`: 列的业务含义描述
        * 确保这些字段的存储结构与LlamaIndex的 `SQLDatabase` 期望格式兼容
    * **注意：** 确保 `table_descriptions` 和 `column_descriptions` 的结构符合LlamaIndex期望的格式，方便直接传递给LlamaIndex的 `table_context_dict` 参数

2. **1.2 实现LlamaIndex SQL数据库适配**
    * **任务：**
        * 创建 `LlamaIndexDBConnector` 类，将我们的 `DatabaseConnection` 转换为LlamaIndex的 `SQLDatabase`
        * 实现表描述和列描述的格式化，确保正确注入到LlamaIndex的上下文中
        * 支持多种数据库类型，封装连接细节

3. **1.3 创建SQLQueryTool工具类**
    * **任务：**
        * 基于LlamaIndex的 `NLSQLTableQueryEngine` 实现 `SQLQueryTool` 类
        * 支持自然语言到SQL的转换
        * 实现查询执行和结果格式化
        * 添加错误处理和重试机制

**阶段二：聊天引擎集成与优化 (对应 `数据库问答.md` 2.4, 3)**

4. **2.1 集成到检索流程**
    * **任务：**
        * 在 `RetrieveFlow` 中添加 `retrieve_from_database` 方法
        * 修改 `retrieve` 方法以同时从知识库和数据库获取信息
        * 实现混合检索结果的评分和排序
        * 格式化数据库查询结果为 `SourceDocument`

5. **2.2 增强聊天引擎配置**
    * **任务：**
        * 扩展 `ChatEngineConfig` 中的 `DatabaseOption` 类
        * 实现 `LinkedDatabaseConfig` 类，支持单引擎多数据库配置
        * 添加数据库查询模式选择配置项
        * 完善权限控制配置项

6. **2.3 实现自动描述生成服务**
    * **任务：**
        * 创建 `TableDescriptionService` 类，使用LLM自动生成表和列描述
        * 设计增量更新和缓存策略，避免频繁生成
        * 实现描述质量评估和优化流程
        * 提供手动编辑和批量生成接口

7. **2.4 优化自然语言到SQL转换**
    * **任务：**
        * 自定义LlamaIndex的 `text_to_sql_prompt` 模板
        * 优化SQL生成和过滤逻辑
        * 实现驱动程序和数据库特定的优化
        * 添加查询结果验证和改进

8. **2.5 解决多数据库路由问题**
    * **任务：**
        * 根据问题内容和上下文，智能选择最合适的数据库
        * 实现 `DatabaseRouter` 类，基于LlamaIndex的 `RouterQueryEngine` 或自定义实现
        * 支持预先过滤不相关数据库，提高效率
        * 实现查询分发和结果合并策略

9. **2.6 改进回答生成和展示**
    * **任务：**
        * **Prompt 工程：**
            * 针对 LlamaIndex `NLSQLTableQueryEngine` 的 `text_to_sql_prompt`，设计和测试不同的模板。
            * 如果需要 LLM 基于 SQL 结果生成最终答案 (`synthesize_response=True`)，则还需要优化其内部使用的 `response_synthesis_prompt`。
            * 将业务描述和动态获取的数据字典信息注入到 Prompt 中，提升 SQL 准确性。
        * **混合答案生成：**
            * 在 `ChatFlow` 中，当同时从知识库和数据库获得结果时，设计一个策略（或使用 LLM 进行 re-ranking/synthesis）来生成统一、连贯的答案。LlamaIndex 的 `QueryPipeline` 可以帮助构建这样的复杂流程。
        * **前端展示：**
            * 在聊天界面清晰标记答案来源 (知识库 vs. 数据库)。
            * 优化表格数据的展示 (`数据库问答.md` 5.3)。
            * 考虑实现 SQL 查询语句和执行计划的可选展示 (调试信息)。

**阶段三：API、前端、测试与文档 (对应 `数据库问答.md` 4.1, 4.2, 5, 6)**

10. **3.1 存储库与API层扩展 (对应 `数据库问答.md` 4.1, 4.2)**
    * **任务：**
        * `DatabaseConnectionRepository`: 增强 CRUD，支持对 `table_descriptions` 和 `column_descriptions` 的更新。
        * API：
            * 表/列描述管理 API (CRUD, 自动生成触发)。
            * 扩展聊天引擎配置 API 以支持 LlamaIndex 相关的数据库设置。
            * 数据库连接测试 API（可复用现有，或增强以测试 LlamaIndex 连接性）。

11. **3.2 前端界面实现 (对应 `数据库问答.md` 5)**
    * **任务：**
        * 数据库描述管理页面 (如前所述)。
        * 聊天引擎配置界面扩展，加入 LlamaIndex 特定配置项。
        * 聊天界面优化 (如前所述)。

12. **3.3 测试与文档 (对应 `数据库问答.md` 6)**
    * **任务：**
        * **单元测试：** 测试 `LlamaIndexDBConnector`, `LlamaIndexSQLQueryTool`, 描述生成服务等。
        * **集成测试：** 测试完整的自然语言到 SQL 到答案的流程，包括多数据库路由。
        * **文档：** 更新开发文档，编写用户手册，提供 LlamaIndex 集成的配置示例和最佳实践。

**实施策略建议 (与 `数据库问答.md` 一致并强调 LlamaIndex)：**

1. **优先打通 LlamaIndex 核心流程：** 快速实现阶段一，确保能用 LlamaIndex 对单个数据库进行基本的 NL 到 SQL 查询。
2. **重点完善描述管理与注入：** 这是提升 LlamaIndex SQL 生成质量的关键。投入资源开发自动描述生成和管理功能。
3. **逐步引入高级功能：** 在核心流程稳定后，再逐步实现多数据库路由、复杂 Prompt 工程、前端优化等。
4. **充分利用 LlamaIndex 组件：** 尽可能使用 LlamaIndex 提供的抽象 (如 `QueryPipeline`, `Tool`, `Router`) 来组织和扩展功能，避免重复造轮子。
5. **迭代与反馈：** 每个阶段完成后进行测试和收集反馈，及时调整后续计划。